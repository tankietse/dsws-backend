<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script src="https://cdn.tailwindcss.com?plugins=forms,typography"></script>
    <script
      src="https://unpkg.com/unlazy@0.11.3/dist/unlazy.with-hashing.iife.js"
      defer
      init
    ></script>
    <script type="text/javascript">
      window.tailwind.config = {
        darkMode: ["class"],
        theme: {
          extend: {
            colors: {
              border: "hsl(var(--border))",
              input: "hsl(var(--input))",
              ring: "hsl(var(--ring))",
              background: "hsl(var(--background))",
              foreground: "hsl(var(--foreground))",
              primary: {
                DEFAULT: "hsl(var(--primary))",
                foreground: "hsl(var(--primary-foreground))",
              },
              secondary: {
                DEFAULT: "hsl(var(--secondary))",
                foreground: "hsl(var(--secondary-foreground))",
              },
              destructive: {
                DEFAULT: "hsl(var(--destructive))",
                foreground: "hsl(var(--destructive-foreground))",
              },
              muted: {
                DEFAULT: "hsl(var(--muted))",
                foreground: "hsl(var(--muted-foreground))",
              },
              accent: {
                DEFAULT: "hsl(var(--accent))",
                foreground: "hsl(var(--accent-foreground))",
              },
              popover: {
                DEFAULT: "hsl(var(--popover))",
                foreground: "hsl(var(--popover-foreground))",
              },
              card: {
                DEFAULT: "hsl(var(--card))",
                foreground: "hsl(var(--card-foreground))",
              },
            },
          },
        },
      };
    </script>
    <style type="text/tailwindcss">
      @layer base {
        :root {
          --background: 0 0% 100%;
          --foreground: 224 71.4% 4.1%;
          --card: 0 0% 100%;
          --card-foreground: 224 71.4% 4.1%;
          --popover: 0 0% 100%;
          --popover-foreground: 224 71.4% 4.1%;
          --primary: 262.1 83.3% 57.8%;
          --primary-foreground: 210 20% 98%;
          --secondary: 220 14.3% 95.9%;
          --secondary-foreground: 220.9 39.3% 11%;
          --muted: 220 14.3% 95.9%;
          --muted-foreground: 220 8.9% 46.1%;
          --accent: 220 14.3% 95.9%;
          --accent-foreground: 220.9 39.3% 11%;
          --destructive: 0 84.2% 60.2%;
          --destructive-foreground: 210 20% 98%;
          --border: 220 13% 91%;
          --input: 220 13% 91%;
          --ring: 262.1 83.3% 57.8%;
        }
        .dark {
          --background: 224 71.4% 4.1%;
          --foreground: 210 20% 98%;
          --card: 224 71.4% 4.1%;
          --card-foreground: 210 20% 98%;
          --popover: 224 71.4% 4.1%;
          --popover-foreground: 210 20% 98%;
          --primary: 263.4 70% 50.4%;
          --primary-foreground: 210 20% 98%;
          --secondary: 215 27.9% 16.9%;
          --secondary-foreground: 210 20% 98%;
          --muted: 215 27.9% 16.9%;
          --muted-foreground: 217.9 10.6% 64.9%;
          --accent: 215 27.9% 16.9%;
          --accent-foreground: 210 20% 98%;
          --destructive: 0 62.8% 30.6%;
          --destructive-foreground: 210 20% 98%;
          --border: 215 27.9% 16.9%;
          --input: 215 27.9% 16.9%;
          --ring: 263.4 70% 50.4%;
        }
      }

      /* Add animation keyframes */
      @keyframes fadeIn {
        from {
          opacity: 0;
          transform: translateY(-10px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      @keyframes slideIn {
        from {
          transform: translateX(20px);
          opacity: 0;
        }
        to {
          transform: translateX(0);
          opacity: 1;
        }
      }

      .animate-fade-in {
        animation: fadeIn 0.6s ease-out both;
      }

      .animate-slide-in {
        animation: slideIn 0.6s ease-out both;
      }

      .input-group {
        margin-bottom: 1.5rem;
      }

      .form-input:focus {
        transform: scale(1.02);
        border-color: theme("colors.primary.DEFAULT");
        box-shadow: 0 0 0 3px theme("colors.primary.DEFAULT");
        transition: all 0.2s ease;
      }

      .hover-lift {
        transition: transform 0.2s ease;
      }

      .hover-lift:hover {
        transform: translateY(-4px);
        box-shadow: 0 8px 15px rgba(0, 0, 0, 0.1);
      }

      /* Add new animations for form switching */
      @keyframes slideOutLeft {
        from {
          transform: translateX(0);
          opacity: 1;
        }
        to {
          transform: translateX(-100%);
          opacity: 0;
        }
      }

      @keyframes slideOutRight {
        from {
          transform: translateX(0);
          opacity: 1;
        }
        to {
          transform: translateX(100%);
          opacity: 0;
        }
      }

      @keyframes slideInLeft {
        from {
          transform: translateX(-100%);
          opacity: 0;
        }
        to {
          transform: translateX(0);
          opacity: 1;
        }
      }

      @keyframes slideInRight {
        from {
          transform: translateX(100%);
          opacity: 0;
        }
        to {
          transform: translateX(0);
          opacity: 1;
        }
      }

      .form-container {
        position: absolute;
        width: 100%;
        transition: transform 0.5s ease-in-out;
      }

      .slide-out-left {
        animation: slideOutLeft 0.5s forwards;
      }

      .slide-out-right {
        animation: slideOutRight 0.5s forwards;
      }

      .slide-in-left {
        animation: slideInLeft 0.5s forwards;
      }

      .slide-in-right {
        animation: slideInRight 0.5s forwards;
      }

      .forms-wrapper {
        position: relative;
        width: 100%;
        height: 100%;
      }
    </style>
    <!-- Add Font Awesome for better icons -->
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"
    />
    <!-- Add Favicon for the tab icon -->
    <link rel="icon" type="image/png" th:href="@{/img/logo.png}" />
    <title>Đăng nhập / Đăng ký - Hệ thống Giám sát và Cảnh báo Dịch bệnh</title>
    <!-- Ensure AuthService is loaded and deferred -->
    <script th:src="@{/js/services/auth-service.js}" defer></script>
  </head>
  <body>
    <div class="flex min-h-screen bg-background">
      <!-- Forms Section -->
      <div
        class="flex-1 flex items-center justify-center p-8 relative overflow-hidden"
      >
        <div class="forms-wrapper w-full max-w-md space-y-8">
          <!-- Login Form -->
          <div id="loginForm" class="form-container animate-fade-in">
            <div
              class="w-full max-w-md space-y-8 bg-card rounded-xl shadow-lg p-10 border border-border/50"
            >
              <div class="text-center space-y-3">
                <h2 class="text-3xl font-bold text-foreground animate-slide-in">
                  Đăng nhập
                </h2>
                <p
                  class="text-muted-foreground animate-slide-in"
                  style="animation-delay: 0.1s"
                >
                  Nhập thông tin đăng nhập của bạn để tiếp tục
                </p>
              </div>

              <form id="loginFormElement" class="space-y-6">
                <div
                  class="input-group animate-slide-in"
                  style="animation-delay: 0.2s"
                >
                  <label
                    class="block text-sm font-medium text-foreground mb-2"
                    for="username"
                  >
                    <i class="fas fa-user mr-2"></i>Tài khoản
                  </label>
                  <input
                    class="form-input mt-1 block w-full border border-border rounded-lg p-3 pl-10 focus:ring focus:ring-ring transition-all duration-200"
                    type="text"
                    id="username"
                    name="username"
                    placeholder="Nhập tên đăng nhập"
                    required
                  />
                </div>
                <div
                  class="input-group animate-slide-in"
                  style="animation-delay: 0.3s"
                >
                  <label
                    class="block text-sm font-medium text-foreground"
                    for="password"
                  >
                    <i class="fas fa-lock mr-2"></i>Mật khẩu
                  </label>
                  <div class="relative">
                    <input
                      class="mt-1 block w-full border border-border rounded-md p-2 pl-10 focus:ring focus:ring-ring transition duration-200"
                      type="password"
                      id="password"
                      name="password"
                      placeholder="Nhập mật khẩu"
                      required
                    />
                    <button
                      type="button"
                      onclick="togglePassword()"
                      class="absolute right-3 top-1/2 -translate-y-1/2"
                    >
                      <i class="fas fa-eye"></i>
                    </button>
                  </div>
                </div>

                <div
                  class="flex items-center justify-between mt-8 animate-slide-in"
                  style="animation-delay: 0.4s"
                >
                  <label class="flex items-center">
                    <input type="checkbox" class="mr-2" name="remember-me" />
                    <span class="text-sm text-muted-foreground"
                      >Ghi nhớ đăng nhập</span
                    >
                  </label>
                  <a href="#" class="text-sm text-primary hover:underline"
                    >Quên mật khẩu?</a
                  >
                </div>

                <button
                  type="submit"
                  class="w-full bg-primary text-primary-foreground hover:bg-primary/90 p-3 rounded-lg transition-all duration-200 flex items-center justify-center hover-lift animate-slide-in"
                  style="animation-delay: 0.5s"
                >
                  <i class="fas fa-sign-in-alt mr-2"></i>
                  ĐĂNG NHẬP
                </button>
              </form>

              <div
                class="relative mt-8 animate-fade-in"
                style="animation-delay: 0.6s"
              >
                <div class="absolute inset-0 flex items-center">
                  <div class="w-full border-t border-border"></div>
                </div>
                <div class="relative flex justify-center text-xs uppercase">
                  <span class="bg-card px-2 text-muted-foreground"
                    >Hoặc đăng nhập với</span
                  >
                </div>
              </div>

              <div class="flex flex-col space-y-3">
                <button
                  class="hover-lift flex items-center justify-center border border-border rounded-lg p-3 transition-all duration-200 hover:bg-secondary animate-slide-in"
                  style="animation-delay: 0.7s"
                >
                  <i class="fab fa-google text-red-500 mr-2"></i>
                  Đăng nhập với Google
                </button>
                <button
                  class="hover-lift flex items-center justify-center border border-border rounded-lg p-3 transition-all duration-200 hover:bg-secondary animate-slide-in"
                  style="animation-delay: 0.7s"
                >
                  <i class="fab fa-facebook text-blue-600 mr-2"></i>
                  Đăng nhập với Facebook
                </button>
              </div>

              <p
                class="text-sm text-center text-muted-foreground mt-8 animate-fade-in"
                style="animation-delay: 0.8s"
              >
                Chưa có tài khoản?
                <a
                  href="#"
                  onclick="switchForms('login', 'register')"
                  class="text-primary hover:underline"
                  >Đăng ký</a
                >
              </p>
            </div>
          </div>

          <!-- Register Form -->
          <div id="registerForm" class="form-container hidden">
            <div
              class="w-full max-w-md space-y-8 bg-card rounded-xl shadow-lg p-10 border border-border/50"
            >
              <div class="text-center space-y-3">
                <h2 class="text-3xl font-bold text-foreground">Đăng ký</h2>
                <p class="text-muted-foreground">
                  Tạo tài khoản mới để sử dụng hệ thống
                </p>
              </div>

              <form id="registerFormElement" class="space-y-6">
                <div class="input-group">
                  <label class="block text-sm font-medium text-foreground mb-2">
                    <i class="fas fa-user mr-2"></i>Tên đăng nhập
                  </label>
                  <input
                    type="text"
                    name="username"
                    class="form-input mt-1 block w-full border border-border rounded-lg p-3 pl-10 focus:ring focus:ring-ring transition-all duration-200"
                    placeholder="Nhập tên đăng nhập"
                    required
                  />
                </div>

                <div class="input-group">
                  <label class="block text-sm font-medium text-foreground mb-2">
                    <i class="fas fa-lock mr-2"></i>Mật khẩu
                  </label>
                  <div class="relative">
                    <input
                      type="password"
                      name="password"
                      class="form-input mt-1 block w-full border border-border rounded-lg p-3 pl-10 focus:ring focus:ring-ring transition-all duration-200"
                      placeholder="Nhập mật khẩu"
                      required
                    />
                  </div>
                </div>

                <div class="input-group">
                  <label class="block text-sm font-medium text-foreground mb-2">
                    <i class="fas fa-envelope mr-2"></i>Email
                  </label>
                  <input
                    type="email"
                    name="email"
                    class="form-input mt-1 block w-full border border-border rounded-lg p-3 pl-10 focus:ring focus:ring-ring transition-all duration-200"
                    placeholder="Nhập địa chỉ email"
                    required
                  />
                </div>

                <div class="input-group">
                  <label class="block text-sm font-medium text-foreground mb-2">
                    <i class="fas fa-user mr-2"></i>Họ và tên
                  </label>
                  <input
                    type="text"
                    name="hoTen"
                    class="form-input mt-1 block w-full border border-border rounded-lg p-3 pl-10 focus:ring focus:ring-ring transition-all duration-200"
                    placeholder="Nhập họ và tên"
                    required
                  />
                </div>

                <div class="input-group">
                  <label class="block text-sm font-medium text-foreground mb-2">
                    <i class="fas fa-phone mr-2"></i>Số điện thoại
                  </label>
                  <input
                    type="tel"
                    name="soDienThoai"
                    class="form-input mt-1 block w-full border border-border rounded-lg p-3 pl-10 focus:ring focus:ring-ring transition-all duration-200"
                    placeholder="Nhập số điện thoại"
                    required
                  />
                </div>

                <button
                  type="submit"
                  class="w-full bg-primary text-primary-foreground hover:bg-primary/90 p-3 rounded-lg transition-all duration-200 flex items-center justify-center hover-lift"
                >
                  <i class="fas fa-user-plus mr-2"></i>
                  ĐĂNG KÝ
                </button>
              </form>

              <p class="text-sm text-center text-muted-foreground">
                Đã có tài khoản?
                <a
                  href="#"
                  onclick="switchForms('register', 'login')"
                  class="text-primary hover:underline"
                >
                  Đăng nhập
                </a>
              </p>
            </div>
          </div>
        </div>
      </div>

      <!-- Background Image Section -->
      <div
        class="hidden lg:block flex-1 relative overflow-hidden m-4 rounded-2xl"
      >
        <img
          th:src="@{/img/auth/pattern.webp}"
          alt="Background"
          class="absolute inset-0 w-full h-full object-cover rounded-2xl"
        />
        <div
          class="absolute inset-0 bg-gradient-to-r from-primary/20 to-primary/40 backdrop-blur-sm rounded-2xl"
        ></div>
        <div class="absolute inset-0 flex items-center justify-center p-12">
          <div class="max-w-md text-white text-center">
            <h1 class="text-4xl font-bold mb-6">
              Hệ thống Giám sát và Cảnh báo Dịch bệnh
            </h1>
            <p class="text-lg opacity-90">
              Giải pháp toàn diện cho việc theo dõi và phòng ngừa dịch bệnh
            </p>
          </div>
        </div>
      </div>
    </div>

    <script>
      document.addEventListener("DOMContentLoaded", async function () {
        try {
          // Remove any local storage token checks
          const isValid = await AuthService.validateToken();
          if (isValid) {
            // Redirect if already authenticated
            const params = new URLSearchParams(window.location.search);
            const redirectUrl =
              params.get("redirect") || AuthService.REDIRECT_URL;
            window.location.href = redirectUrl;
          }
        } catch (error) {
          console.error("Auth check failed:", error);
        }
      });

      document
        .getElementById("loginFormElement")
        .addEventListener("submit", async (e) => {
          e.preventDefault();
          const username = document.getElementById("username").value;
          const password = document.getElementById("password").value;

          try {
            await AuthService.login(username, password);
          } catch (error) {
            alert("Đăng nhập thất bại: " + error.message);
          }
        });

      function togglePassword() {
        const password = document.getElementById("password");
        const type =
          password.getAttribute("type") === "password" ? "text" : "password";
        password.setAttribute("type", type);
        const icon = document.querySelector(
          'button[onclick="togglePassword()"] i'
        );
        icon.classList.toggle("fa-eye");
        icon.classList.toggle("fa-eye-slash");
      }

      // Sửa lại hàm switchForms để hoạt động chính xác hơn
      function switchForms(from, to) {
        const fromForm = document.getElementById(`${from}Form`);
        const toForm = document.getElementById(`${to}Form`);
        const bgSection = document.querySelector(".hidden.lg\\:block"); // Select background section

        // Determine animation directions
        const outDirection = to === "login" ? "right" : "left";
        const inDirection = to === "login" ? "left" : "right";

        // Remove any existing animation classes
        fromForm.classList.remove("slide-in-left", "slide-in-right");
        toForm.classList.remove("slide-in-left", "slide-in-right", "hidden");

        // Add animation classes
        fromForm.classList.add(`slide-out-${outDirection}`);
        toForm.classList.add(`slide-in-${inDirection}`);

        // Update form visibility after animation
        setTimeout(() => {
          fromForm.classList.add("hidden");
          fromForm.classList.remove(`slide-out-${outDirection}`);
          toForm.classList.remove(`slide-in-${inDirection}`);

          // Update page title
          document.title =
            to === "login"
              ? "Đăng nhập"
              : "Đăng ký" + " - Hệ thống Giám sát và Cảnh báo Dịch bệnh";
        }, 500);
      }

      // Add event listeners for form switching
      document.addEventListener("DOMContentLoaded", function () {
        // Add click handler for registration link
        document.querySelector('a[href="#"][onclick*="switchForms"]').onclick =
          function (e) {
            e.preventDefault();
            switchForms("login", "register");
          };

        // Add click handler for login link
        document.querySelector(
          '#registerForm a[onclick*="switchForms"]'
        ).onclick = function (e) {
          e.preventDefault();
          switchForms("register", "login");
        };

        // Handle register form submission
        document
          .getElementById("registerFormElement")
          .addEventListener("submit", function (e) {
            e.preventDefault();
            const formData = new FormData(this);
            const data = Object.fromEntries(formData.entries());
            fetch("/api/v1/auth/register", {
              method: "POST", 
              credentials: "include",
              headers: {
                "Content-Type": "application/json",
                Accept: "application/json",
              },
              body: JSON.stringify(data),
            })
              .then((response) => {
                if (response.ok) {
                  alert("Đăng ký thành công");
                  switchForms("register", "login");
                } else {
                  return response.json().then((data) => {
                    throw new Error(data.message || "Đăng ký thất bại");
                  });
                }
              })
              .catch((error) => {
                alert("Lỗi khi đăng ký: " + error.message);
              });
          });
      });
    </script>
  </body>
</html>
